# Ruby CircleCI 2.0 configuration file
#
version: 2
jobs:
  build:
    docker:
      # specify the version you desire here
      - image: circleci/ruby:2.5.3
    working_directory: ~/workspace
    steps:
      - checkout
      - run:
          name: Ruby dependencies
          command: bundle install
      - run:
          name: Build
          command: JEKYLL_ENV=production bundle exec jekyll build --verbose
      - persist_to_workspace:
          root: ~/workspace
          paths:
            - _site
          
  deploy:
    docker:
      # specify the version you desire here
      - image: google/cloud-sdk:latest
    working_directory: ~/workspace
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Deploy
          command: |
            echo "Deploying to otladeps.tech App Engine"
            echo $ACCOUNT_KEY_STAGING > service_key.txt
            base64 -i service_key.txt -d > ${HOME}/gcloud-service-key.json
            gcloud auth activate-service-account ${ACCOUNT_ID} --key-file ${HOME}/gcloud-service-key.json
            gcloud config set project adroit-goods-251611
            cd /tmp/workspace/_site/ && gcloud app deploy
            echo " Successfully deployed to App Engine" 
workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build